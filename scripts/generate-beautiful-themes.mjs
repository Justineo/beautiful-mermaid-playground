import { mkdir, readFile, writeFile } from "node:fs/promises";
import path from "node:path";
import { createJiti } from "jiti";

const ROOT = process.cwd();
const OUTPUT_PATH = path.join(ROOT, "src/generated/beautifulThemes.ts");
const OUTPUT_DIR = path.dirname(OUTPUT_PATH);

function toPrettyJson(value) {
  return JSON.stringify(value, null, 2);
}

async function writeIfChanged(filePath, content) {
  let previous = null;
  try {
    previous = await readFile(filePath, "utf8");
  } catch {
    previous = null;
  }

  if (previous === content) {
    return false;
  }

  await mkdir(path.dirname(filePath), { recursive: true });
  await writeFile(filePath, content, "utf8");
  return true;
}

function normalizeThemes(themes) {
  return Object.fromEntries(
    Object.entries(themes)
      .sort(([left], [right]) => left.localeCompare(right))
      .map(([name, tokens]) => [name, tokens]),
  );
}

async function main() {
  const jiti = createJiti(import.meta.url);
  const runtime = jiti("beautiful-mermaid");

  const defaults = runtime.DEFAULTS;
  const themes = runtime.THEMES;

  if (!defaults || typeof defaults !== "object") {
    throw new Error("Failed to read DEFAULTS from beautiful-mermaid");
  }

  if (!themes || typeof themes !== "object") {
    throw new Error("Failed to read THEMES from beautiful-mermaid");
  }

  const normalizedThemes = normalizeThemes(themes);
  const fileContent = `/* eslint-disable */\n// Generated by scripts/generate-beautiful-themes.mjs. Do not edit manually.\n\nexport const DEFAULT_THEME_TOKENS = ${toPrettyJson(defaults)} as const\n\nexport const BEAUTIFUL_THEME_TOKENS = ${toPrettyJson(normalizedThemes)} as const\n\nexport type DiagramThemeName = keyof typeof BEAUTIFUL_THEME_TOKENS\n`;

  await mkdir(OUTPUT_DIR, { recursive: true });
  const written = await writeIfChanged(OUTPUT_PATH, fileContent);
  const verb = written ? "Generated" : "Up-to-date";
  console.log(`${verb} ${path.relative(ROOT, OUTPUT_PATH)}`);
}

main().catch((error) => {
  console.error(error instanceof Error ? error.message : String(error));
  process.exitCode = 1;
});
